name: RustDesk Server Setup

on:
  workflow_dispatch:

jobs:
  rustdesk-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour max

    steps:
    - name: Install dependencies
      run: sudo apt update && sudo apt install -y wget unzip

    - name: Download and setup RustDesk
      run: |
        # Clean previous runs
        rm -rf rustdesk-server || true
        
        # Download latest version
        wget https://github.com/rustdesk/rustdesk-server/releases/latest/download/rustdesk-server-linux-amd64.zip
        unzip rustdesk-server-linux-amd64.zip -d rustdesk-server
        
        # Navigate to binary directory
        cd rustdesk-server/amd64
        chmod +x hbbr hbbs
        
        # Start services with debug logging
        RUST_LOG=debug nohup ./hbbs -r 0.0.0.0 > hbbs.log 2>&1 &
        RUST_LOG=debug nohup ./hbbr > hbbr.log 2>&1 &
        
        # Wait for initialization
        sleep 10
        
        # Get connection details
        IP=$(curl -s ifconfig.me)
        ID=$(grep "ID" hbbs.log | tail -1 | awk '{print $NF}')
        
        echo "SERVER_IP=$IP" >> $GITHUB_ENV
        echo "REMOTE_ID=$ID" >> $GITHUB_ENV
        echo "PUBLIC_KEY=$(cat id_ed25519.pub 2>/dev/null || echo 'NOT_FOUND')" >> $GITHUB_ENV

    - name: Display connection info
      run: |
        echo "=========================================="
        echo "üñ•Ô∏è RUSTDESK SERVER READY"
        echo "üåê Server IP: ${{ env.SERVER_IP }}"
        echo "üîë Remote ID: ${{ env.REMOTE_ID }}"
        echo "üîê Public Key: ${{ env.PUBLIC_KEY }}"
        echo ""
        echo "INSTRUCTIONS:"
        echo "1. In RustDesk client settings:"
        echo "   - Set ID Server to: ${{ env.SERVER_IP }}"
        echo "   - Set Relay Server to: ${{ env.SERVER_IP }}"
        echo "2. Connect using Remote ID above"
        echo "3. Verify public key when prompted"
        echo ""
        echo "Ports required: 21115-21119 TCP/UDP"
        echo "Session expires after 6 hours"
        echo "=========================================="
        
        # Keep alive
        sleep 6h
