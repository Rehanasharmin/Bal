name: RustDesk Server with Cloudflare Tunnel

on:
  workflow_dispatch:

jobs:
  rustdesk-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour max

    steps:
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y wget unzip

    - name: Setup RustDesk Server
      run: |
        # Clean and setup
        rm -rf rustdesk-server || true
        wget https://github.com/rustdesk/rustdesk-server/releases/latest/download/rustdesk-server-linux-amd64.zip
        unzip rustdesk-server-linux-amd64.zip -d rustdesk-server
        cd rustdesk-server/amd64
        chmod +x hbbr hbbs

        # Start services
        nohup ./hbbs -r 0.0.0.0 > hbbs.log 2>&1 &
        nohup ./hbbr > hbbr.log 2>&1 &
        sleep 5

        # Get ID from key file
        REMOTE_ID=$(head -c 16 id_ed25519.pub | base64 | tr -d '=')
        echo "REMOTE_ID=$REMOTE_ID" >> $GITHUB_ENV

    - name: Setup Cloudflare Tunnel
      run: |
        # Download cloudflared
        cd ~
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        
        # Create simple domain name (no hyphens)
        TUNNEL_NAME=rustdesk$(openssl rand -hex 3)
        
        # Start tunnel
        cd $GITHUB_WORKSPACE/rustdesk-server/amd64
        nohup ~/cloudflared-linux-amd64 tunnel --url tcp://localhost:21116 --hostname ${TUNNEL_NAME}.trycloudflare.com > tunnel.log 2>&1 &
        sleep 15

        # Get clean tunnel URL
        echo "TUNNEL_URL=${TUNNEL_NAME}.trycloudflare.com" >> $GITHUB_ENV
        echo "FULL_CONNECTION_STRING=${TUNNEL_NAME}.trycloudflare.com:21116" >> $GITHUB_ENV

    - name: Display Connection Info
      run: |
        echo "=========================================="
        echo "üñ•Ô∏è RUSTDESK CONNECTION INSTRUCTIONS"
        echo "üîë Your Remote ID: ${{ env.REMOTE_ID }}"
        echo "üåê Tunnel Address: ${{ env.TUNNEL_URL }}"
        echo "üîå Full Connection: ${{ env.FULL_CONNECTION_STRING }}"
        echo ""
        echo "IN YOUR RUSTDESK CLIENT:"
        echo "1. Go to Settings ‚Üí Network"
        echo "2. Set BOTH fields to: ${{ env.TUNNEL_URL }}"
        echo "3. Click OK and restart RustDesk"
        echo "4. Connect using Remote ID above"
        echo ""
        echo "If connection fails:"
        echo "- Wait 1-2 minutes"
        echo "- Try again with: ${{ env.FULL_CONNECTION_STRING }}"
        echo "=========================================="
        
        # Keep alive
        sleep 6h
