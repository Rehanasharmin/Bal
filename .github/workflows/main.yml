name: RustDesk Server via Cloudflare

on: workflow_dispatch

jobs:
  rustdesk-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6 hours

    steps:
    - name: Install RustDesk Server
      run: |
        # Install dependencies
        sudo apt update
        sudo apt install -y wget unzip xvfb libxcb-randr0-dev libxdo-dev libxfixes-dev libxcb-shape0-dev libxcb-xfixes0-dev
        
        # Download and extract RustDesk
        wget https://github.com/rustdesk/rustdesk-server/releases/download/1.1.9/rustdesk-server-linux-amd64.zip
        unzip rustdesk-server-linux-amd64.zip -d rustdesk-server
        cd rustdesk-server
        chmod +x hbbr hbbs

        # Start RustDesk services
        nohup ./hbbs -r 0.0.0.0 > hbbs.log 2>&1 &
        nohup ./hbbr > hbbr.log 2>&1 &
        sleep 5

    - name: Setup Cloudflare Tunnel
      run: |
        cd rustdesk-server
        # Install cloudflared
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared

        # Start tunnels for both RustDesk ports
        nohup ./cloudflared tunnel --url tcp://localhost:21117 --hostname rustdesk-$(openssl rand -hex 4).trycloudflare.com > tunnel1.log 2>&1 &
        nohup ./cloudflared tunnel --url tcp://localhost:21116 --hostname rustdesk-$(openssl rand -hex 4).trycloudflare.com > tunnel2.log 2>&1 &
        sleep 15

        # Get connection info
        ID=$(grep "ID" hbbs.log | awk '{print $5}')
        echo "=========================================="
        echo "üñ•Ô∏è RUSTDESK SERVER READY"
        echo ""
        echo "üîë Connection Details:"
        echo "ID: $ID"
        echo "Password: (Will be generated on first client connection)"
        echo ""
        echo "üåê Tunnel Addresses:"
        grep -o "https://.*trycloudflare.com" tunnel*.log | sort | uniq
        echo ""
        echo "‚ö†Ô∏è Note: Use same tunnel for both ports in RustDesk client"
        echo "=========================================="

        # Keep alive
        sleep 6h
