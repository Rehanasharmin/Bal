name: XFCE AnyDesk Remote Desktop
on:
  workflow_dispatch:
    inputs:
      anydesk_password:
        description: 'AnyDesk Password for Unattended Access'
        required: true

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure APT sources and install software
      run: |
        # Use official Ubuntu mirrors to prevent 404 errors.
        sudo sh -c 'echo "deb http://archive.ubuntu.com/ubuntu/ $(lsb_release -cs) main universe" > /etc/apt/sources.list'
        sudo apt-get update
        sudo apt-get clean

        # Add the AnyDesk GPG key and repository.
        sudo apt install -y ca-certificates curl apt-transport-https
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://keys.anydesk.com/repos/DEB-GPG-KEY | sudo gpg --dearmor -o /etc/apt/keyrings/keys.anydesk.com.gpg
        echo "deb [signed-by=/etc/apt/keyrings/keys.anydesk.com.gpg] http://deb.anydesk.com all main" | sudo tee /etc/apt/sources.list.d/anydesk-stable.list > /dev/null

        # Update APT caches and install AnyDesk and XFCE.
        sudo apt update
        sudo apt install -y anydesk xfce4 desktop-base dbus-x11 xscreensaver xvfb

    - name: Start XFCE and configure AnyDesk
      env:
        ANYDESK_PASSWORD: ${{ github.event.inputs.anydesk_password }}
      run: |
        # Start XFCE in the background.
        /usr/bin/xvfb-run --server-num=99 --listen-tcp -l -f -a --server-args="-screen 0 1024x768x24" xfce4-session &

        # Stop the AnyDesk service to prevent interference during configuration.
        sudo service anydesk stop

        # Manually create the necessary .anydesk directory for the runner user.
        mkdir -p ~/.anydesk

        # Use the `anydesk --gen-pass` command to generate the password hash and store it correctly.
        # This will now succeed as the directory exists.
        echo "$ANYDESK_PASSWORD" | anydesk --gen-pass --with-pw-salt > ~/.anydesk/service.conf

        # Copy the runner user's config to the system-wide location.
        sudo cp ~/.anydesk/service.conf /etc/anydesk/

        # Enable unattended access in the AnyDesk configuration.
        sudo sed -i 's/#ad.security.enabled=false/ad.security.enabled=true/' /etc/anydesk/service.conf

        # Restart the AnyDesk service.
        sudo service anydesk start

        # Wait for AnyDesk to generate an ID and register with the service.
        sleep 10
        
        # Get and display the AnyDesk ID.
        ANYDESK_ID=$(anydesk --get-id)
        echo "AnyDesk ID for this session: $ANYDESK_ID"
        echo "Connect using the AnyDesk ID and the password you provided."
        
    - name: Keep the job alive
      run: |
        # Use a `sleep` command to keep the job running.
        echo "Keeping the session alive for 6 hours. End the workflow run to terminate the session."
        sleep 21600
