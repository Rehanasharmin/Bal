name: XFCE AnyDesk Remote Desktop
on:
  workflow_dispatch:
    inputs:
      anydesk_password:
        description: 'AnyDesk Password for Unattended Access'
        required: true

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure APT sources and install software
      run: |
        # Use official Ubuntu mirrors to prevent 404 errors.
        sudo sh -c 'echo "deb http://archive.ubuntu.com/ubuntu/ $(lsb_release -cs) main universe" > /etc/apt/sources.list'
        sudo apt-get update
        sudo apt-get clean

        # Install AnyDesk and XFCE environment packages.
        sudo apt-get install --fix-missing -y xfce4 desktop-base dbus-x11 xscreensaver xvfb
        wget https://download.anydesk.com/linux/anydesk_6.3.0-1_amd64.deb # Replace with latest version if needed
        sudo apt-get install --assume-yes ./anydesk_6.3.0-1_amd64.deb

    - name: Start XFCE and configure AnyDesk
      env:
        ANYDESK_PASSWORD: ${{ github.event.inputs.anydesk_password }}
      run: |
        # Start XFCE in the background.
        /usr/bin/xvfb-run --server-num=99 --listen-tcp -l -f -a --server-args="-screen 0 1024x768x24" xfce4-session &

        # Set the AnyDesk password for unattended access.
        # This requires root privileges.
        echo "$ANYDESK_PASSWORD" | sudo anydesk --set-password

        # Wait for AnyDesk to generate an ID and register with the service.
        sleep 10
        
        # Get and display the AnyDesk ID.
        ANYDESK_ID=$(anydesk --get-id)
        echo "AnyDesk ID for this session: $ANYDESK_ID"
        echo "Connect using the AnyDesk ID and the password you provided."
        
    - name: Keep the job alive
      run: |
        # Use a `sleep` command to keep the job running. The job will terminate after about 6 hours.
        echo "Keeping the session alive for 6 hours. End the workflow run to terminate the session."
        sleep 21600
