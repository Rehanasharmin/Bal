name: XFCE AnyDesk Remote Desktop
on:
  workflow_dispatch:
    inputs:
      anydesk_password:
        description: 'AnyDesk Password for Unattended Access'
        required: true

jobs:
  remote-desktop:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure APT sources and install software
      run: |
        # Use official Ubuntu mirrors to prevent 404 errors.
        sudo sh -c 'echo "deb http://archive.ubuntu.com/ubuntu/ $(lsb_release -cs) main universe" > /etc/apt/sources.list'
        sudo apt-get update
        sudo apt-get clean

        # Add the AnyDesk GPG key and repository.
        sudo apt install -y ca-certificates curl apt-transport-https
        sudo install -m 0755 -d /etc/apt/keyrings
        curl -fsSL https://keys.anydesk.com/repos/DEB-GPG-KEY | sudo gpg --dearmor -o /etc/apt/keyrings/keys.anydesk.com.gpg
        echo "deb [signed-by=/etc/apt/keyrings/keys.anydesk.com.gpg] http://deb.anydesk.com all main" | sudo tee /etc/apt/sources.list.d/anydesk-stable.list > /dev/null

        # Update APT caches and install AnyDesk and XFCE.
        sudo apt update
        sudo apt install -y anydesk xfce4 desktop-base dbus-x11 xscreensaver xvfb

    - name: Start XFCE and configure AnyDesk
      env:
        ANYDESK_PASSWORD: ${{ github.event.inputs.anydesk_password }}
      run: |
        # Start XFCE in the background.
        /usr/bin/xvfb-run --server-num=99 --listen-tcp -l -f -a --server-args="-screen 0 1024x768x24" xfce4-session &

        # Set the AnyDesk password for unattended access reliably.
        # This sends the password to the command via standard input.
        echo "$ANYDESK_PASSWORD" | anydesk --set-password

        # Wait for AnyDesk to generate an ID and register with the service.
        sleep 10
        
        # Get and display the AnyDesk ID.
        ANYDESK_ID=$(anydesk --get-id)
        echo "AnyDesk ID for this session: $ANYDESK_ID"
        echo "Connect using the AnyDesk ID and the password you provided."
        
    - name: Keep the job alive
      run: |
        # Use a `sleep` command to keep the job running.
        echo "Keeping the session alive for 6 hours. End the workflow run to terminate the session."
        sleep 21600
