name: RustDesk Server Setup

on:
  workflow_dispatch:

jobs:
  rustdesk-server:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hour max

    steps:
    - name: Install dependencies
      run: sudo apt update && sudo apt install -y wget unzip

    - name: Setup RustDesk Server
      run: |
        # Clean and setup
        rm -rf rustdesk-server || true
        wget https://github.com/rustdesk/rustdesk-server/releases/latest/download/rustdesk-server-linux-amd64.zip
        unzip rustdesk-server-linux-amd64.zip -d rustdesk-server
        cd rustdesk-server/amd64
        chmod +x hbbr hbbs

        # Start services
        nohup ./hbbs -r 0.0.0.0 > hbbs.log 2>&1 &
        nohup ./hbbr > hbbr.log 2>&1 &
        sleep 5

        # Get REAL connection details
        IP=$(curl -s ifconfig.me)
        echo "RUSTDESK_IP=$IP" >> $GITHUB_ENV
        echo "SERVER_ID=$(grep 'ID' hbbs.log 2>/dev/null | tail -1 | awk '{print $NF}' || echo 'NOT_FOUND')" >> $GITHUB_ENV

    - name: Display ACTUAL Connection Info
      run: |
        echo "=========================================="
        echo "üñ•Ô∏è REAL RUSTDESK CONNECTION DETAILS"
        echo ""
        echo "IN RUSTDESK CLIENT:"
        echo "1. Go to Settings ‚Üí Network"
        echo "2. Set ID Server to: ${{ env.RUSTDESK_IP }}"
        echo "3. Set Relay Server to: ${{ env.RUSTDESK_IP }}"
        echo "4. Click OK and restart RustDesk"
        echo ""
        echo "Then use this ID to connect: ${{ env.SERVER_ID }}"
        echo ""
        echo "NOTE: You may need to:"
        echo "- Open ports 21115-21119 on your firewall"
        echo "- Wait 1-2 minutes after startup"
        echo "=========================================="
        
        # Keep alive
        sleep 6h
